<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

use App\Http\Requests;
use App\Http\Controllers\Controller;
use App\Saipure;
use App\Movie;
use App\Box;
class UserController extends Controller
{
    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */

    public function index()
    {
        
         $Movies = Movie::get();
        session_start();
        
       if (!isset($_SESSION["user"])) {
              return view('saipure.index')->with('UserID',null)->with('Movies',$Movies);
        }   
        
      return redirect()->route('home.index')->with('Movies',$Movies);
    }

    /**
     * Show the form for creating a new resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function create(Request $request)
    {
        
    }

    /**
     * Store a newly created resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function store(Request $request)
    {   $User = Saipure::where('Username',$request->input('Username'))->first();
       
        if ($request->input('Password')!=$request->input('Password2')) {
            return view('saipure.register')->with('textUser','')
                                      ->with('textEE','')
                                      ->with('textP','รหัสผ่านไม่ตรงกัน !!');
        
        }elseif ($request->input('Username')==''||$request->input('Password')==''||$request->input('Name')==''||$request->input('email')==''){
            return view('saipure.register')->with('textUser','')
                                            ->with('textEE','กรุณากรอกข้อมูลให้ครบถ้วน !!')->with('textP','');
        }elseif ($User==null) {

        $store = new Saipure;
        $store->Username = $request->input('Username');
        $store->Password = $request->input('Password');
        $store->Name = $request->input('Name');
        $store->email = $request->input('email');
        $store->Point = 0;
        $store->Status = 'USER';
        $store->save();
        

        return view('saipure.registered'); 
        }
        return view('saipure.register')->with('textUser','มีผู้ใช้ Usernameนี้แล้ว')
                                      ->with('textEE','')->with('textP','');
    }
    public function registered()
    {
        session_start();
        if ($_SESSION["user"]==null) {
             return view('saipure.registered');
        }elseif ($_SESSION["user"]!=null) {
            
              return redirect()->route('user.show')->with("Username",$_SESSION["user"]->UserID);
        }
        
    }

    public function check(Request $request)
    {

        if($request->input('txtUsername')==null or $request->input('txtPassword')==null)
        {
            
            return view('saipure.login')->with('tt',"กรุณากรอกข้อมูลให้ครบถ้วน");

        }
        else
        {

            
            $User = Saipure::where('Username',$request->input('txtUsername'))->first();
            if(!$User)
            {

                return view('saipure.login')->with('tt',"ไม่พบ Username !!");
            }
            if ($User->Password!=$request->input('txtPassword')) {
                return view('saipure.login')->with('tt',"รหัสผ่านไม่ถูกต้อง !!");
            }elseif ($User->Status == 'USER') {
                # code..
                $Movies = Movie::get();
               
                $boxs = Box::where('UserID',$User->UserID)->get();
                $MoviesBox=array();
                foreach ($boxs as $box){

                    $Movie = Movie::find((int)$box->MovieID);
                    array_push($MoviesBox,$Movie);
                }
                return view('saipure.index2')->with('User',$User)->with('Movies',$Movies)->with('MoviesBox',$MoviesBox);
            }elseif ($User->Status == 'ADMIN') {
                 return  view('saipure.Cadmin')->with('User',$User);
                // $admins = Saipure::get();
                // return view('saipure.admin')->with('User',$User)->with("admins",$admins)->with("Tx",'');
            }else{
                return view('saipure.login')->with('tt',"ID ของคุณถูกระงับการใช้งาน !!");
            }
            // return view('user.check_login')->with('Users',$Users);
        }
        
    
    }

    /**
     * Display the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function show($id)
    {
        session_start();
        if ($_SESSION["user"]==null) {

            return view('saipure.login')->with('tt','');
        }
        $User = Saipure::find($id);
        $Movies = Movie::get();




        $boxs = Box::where('UserID',$id)->get();
        $MoviesBox=array();
        foreach ($boxs as $box){

            $Movie = Movie::find((int)$box->MovieID);
            array_push($MoviesBox,$Movie);
        }




         return view('saipure.index2')->with('User',$User)->with('Movies',$Movies)->with('MoviesBox',$MoviesBox);
    }

    /**
     * Show the form for editing the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function edit($id)
    {
        session_start();
        
        if ($_SESSION["user"]==null) {

            return view('saipure.login');
        }
        $User = Saipure::find($id);
        return view('saipure.edit')->with('User',$User)->with('textEE','')->with('textP','')->with('ff','');
         
    }

    /**
     * Update the specified resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function update(Request $request, $id)
    {
        session_start();
        if ($_SESSION["user"]==null) {

            return view('saipure.login')->with('tt','');
        }


        $update = Saipure::find($id);
        $User = Saipure::find($id);
        if($request->input('Name')==''||$request->input('Password')==''||$request->input('email')=='')
        {
            return view('saipure.edit')->with('User',$User)->with('textEE','กรุณากรอกข้อมูลให้ครบถ้วน !!')->with('textP','')->with('ff','');
        }elseif ($request->input('Password')!=$request->input('Password2')) {
            return view('saipure.edit')->with('User',$User)->with('textEE','')->with('textP','รหัสผ่านไม่ตรงกัน !!')->with('ff','');
        }

        $update->Name = $request->input('Name');
        $update->Password = $request->input('Password');
        $update->email = $request->input('email');
        $update->save();
        $User = Saipure::find($id);
        return view('saipure.edit')->with('User',$User)->with('textEE','')->with('textP','')->with('ff','สำเร็จ !!');
                          
    }

    /**
     * Remove the specified resource from storage.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function destroy($id)
    {
        //
    }
    public function login()
    {
        session_start();
        if ($_SESSION["user"]==null) {

            return view('saipure.login')->with('tt','');
        }elseif ($_SESSION["user"]!=null) {
            
              return redirect()->route('user.show')->with("Username",$_SESSION["user"]->UserID);
        }
         
    }
    public function logout()
    {
        session_start();
        session_destroy();
         $Movies = Movie::get();
        return redirect()->route('home.index')->with('Movies',$Movies);
    }
}
